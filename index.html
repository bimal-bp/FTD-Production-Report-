<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Billing System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
  
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
  
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
  
        .main-content {
            flex: 1;
        }
  
        .dashboard-sidebar {
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
        }
  
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
  
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
  
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
  
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
  
        .form-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
  
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
  
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
  
        select:focus, input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
  
        button {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 25px;
        }
  
        button:hover {
            background-color: #1565c0;
        }
  
        .btn-secondary {
            background-color: #4caf50;
            margin-left: 10px;
        }
  
        .btn-secondary:hover {
            background-color: #388e3c;
        }
  
        .btn-print {
            background-color: #ff9800;
            margin-left: 10px;
        }
  
        .btn-print:hover {
            background-color: #f57c00;
        }
  
        .btn-download {
            background-color: #9c27b0;
            margin-left: 10px;
        }
  
        .btn-download:hover {
            background-color: #7b1fa2;
        }
  
        .results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
  
        .results-header {
            background-color: #1e88e5;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
  
        .results-content {
            padding: 25px;
        }
  
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
  
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
  
        .result-title {
            font-weight: 600;
            color: #1e88e5;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
  
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
  
        .add-vendor-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            display: none;
        }
  
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
  
        .form-field {
            flex: 1;
            min-width: 250px;
        }
  
        .vehicle-numbers-container {
            margin-top: 15px;
        }
  
        .vehicle-number-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
  
        .remove-vehicle {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
  
        .add-vehicle {
            background-color: #9e9e9e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
  
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
  
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
  
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
  
        .suggestion-item:last-child {
            border-bottom: none;
        }
  
        .highlight {
            background-color: #e3f2fd;
            font-weight: bold;
        }
  
        .transport-details {
            margin-top: 30px;
        }
  
        .transport-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
  
        .transport-table th, .transport-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
  
        .transport-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
  
        .transport-table tr:hover {
            background-color: #f5f5f5;
        }
        .transport-table tr.verified {
            background-color: #dff0d8 !important;
        }
  
        .summary-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
  
        .summary-item {
            text-align: center;
            flex: 1;
        }
  
        .summary-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
  
        .summary-value {
            font-size: 24px;
            color: #1b5e20;
            font-weight: 700;
        }
  
        .summary-divider {
            width: 2px;
            height: 50px;
            background-color: #4caf50;
            margin: 0 20px;
        }
  
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-weight: 600;
        }
  
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e88e5;
        }
  
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
  
        .saved-results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            padding: 25px;
        }
  
        .saved-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
  
        .saved-results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
  
        .saved-results-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
        }
  
        .saved-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
  
        .saved-result-item:last-child {
            border-bottom: none;
        }
  
        .saved-result-info {
            flex: 1;
        }
  
        .saved-result-actions {
            display: flex;
            gap: 10px;
        }
  
        .btn-remove {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
  
        .btn-view {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
  
        .vendor-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
  
        .vendor-header {
            background-color: #e3f2fd;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
  
        .vendor-vehicles {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
  
        .vendor-vehicles.expanded {
            max-height: 500px;
            padding: 15px 20px;
        }
  
        .vehicle-option {
            padding: 10px 15px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
  
        .vehicle-option:hover {
            background-color: #f5f5f5;
        }
  
        .vehicle-option.selected {
            background-color: #e3f2fd;
            border-color: #1e88e5;
        }
  
        .amount-edit {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
  
        .amount-input {
            width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
  
        .btn-update {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
  
        .vehicle-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
  
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e88e5;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
  
        .dashboard-section {
            margin-bottom: 25px;
        }
  
        .dashboard-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
  
        .dashboard-summary-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
  
        .dashboard-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
  
        .dashboard-summary-item:last-child {
            margin-bottom: 0;
        }
  
        .dashboard-label {
            font-weight: 500;
            color: #555;
        }
  
        .dashboard-value {
            font-weight: 600;
            color: #1e88e5;
        }
  
        .dashboard-highlight {
            font-weight: 700;
            color: #1565c0;
            font-size: 1.1rem;
        }
  
        .product-breakdown {
            margin-top: 15px;
        }
  
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
  
        .product-name {
            font-weight: 500;
        }
  
        .product-qty {
            font-weight: 600;
            color: #2e7d32;
        }
  
        .product-amount {
            font-weight: 600;
            color: #d32f2f;
        }
  
        .dashboard-refresh {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
  
        .dashboard-refresh:hover {
            background-color: #1565c0;
        }
  
        .dashboard-loading {
            text-align: center;
            padding: 10px;
            color: #1e88e5;
            font-style: italic;
        }
  
        .vendor-total-summary {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
  
        .vendor-total-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 15px;
            text-align: center;
        }
  
        .vendor-total-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
  
        .vendor-total-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
  
        .vendor-total-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
  
        .vendor-total-value {
            font-size: 20px;
            color: #1b5e20;
            font-weight: 700;
        }
  
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
      
            .dashboard-sidebar {
                width: 100%;
                order: -1;
                margin-bottom: 20px;
            }
      
            .form-group, .form-field {
                min-width: 100%;
            }
      
            h1 {
                font-size: 2rem;
            }
      
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
      
            .transport-table {
                display: block;
                overflow-x: auto;
            }
      
            .saved-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
      
            .saved-result-actions {
                width: 100%;
                justify-content: flex-end;
            }
      
            .amount-edit {
                flex-direction: column;
                align-items: flex-start;
            }
      
            .amount-input {
                width: 100%;
            }
      
            .summary-box {
                flex-direction: column;
                gap: 15px;
            }
      
            .summary-divider {
                width: 100%;
                height: 2px;
                margin: 10px 0;
            }
      
            .vendor-total-details {
                flex-direction: column;
                gap: 10px;
            }
        }
  
        @media print {
            .search-section, .add-vendor-section, .btn-print, .saved-results-section, .dashboard-sidebar {
                display: none;
            }
      
            .results-section {
                display: block !important;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header>
                <h1>SGX - Transport Billing System</h1>
            </header>
      
            <section class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="vehicleSearch">Search Vehicle Number:</label>
                        <input type="text" id="vehicleSearch" placeholder="Start typing vehicle number (e.g., AP39UJ)" autocomplete="off">
                        <div class="suggestions-container" id="suggestionsContainer"></div>
                    </div>
                    <div class="form-group">
                        <label for="dcSearch">Search Delivery Challan No:</label>
                        <input type="text" id="dcSearch" placeholder="Enter Delivery Challan No" autocomplete="off">
                        <div class="suggestions-container" id="dcSuggestionsContainer"></div>
                    </div>
                </div>
          
                <button type="button" onclick="searchVehicle()">Search Vehicle</button>
                <button type="button" onclick="searchDC()">Search Delivery Challan No</button>
                <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Add New Vendor</button>
                <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
            </section>
      
            <section class="results-section" id="resultsSection">
                <div class="results-header">
                    <span>Vehicle Details</span>
                    <div>
                        <button type="button" class="btn-secondary" onclick="saveCurrentResult()">Save to List</button>
                        <button type="button" class="btn-print" onclick="printResults()">Print</button>
                    </div>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be displayed here -->
                </div>
            </section>
      
            <section class="add-vendor-section" id="addVendorSection">
                <div class="results-header">Add New Vendor</div>
                <div class="results-content">
                    <form id="vendorForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="partyName">Party Name:</label>
                                <input type="text" id="partyName" required>
                            </div>
                            <div class="form-field">
                                <label for="accountNo">Account Number:</label>
                                <input type="text" id="accountNo" required>
                            </div>
                        </div>
                  
                        <div class="form-row">
                            <div class="form-field">
                                <label for="bankName">Bank Name & Branch:</label>
                                <input type="text" id="bankName" required>
                            </div>
                            <div class="form-field">
                                <label for="beneficiary">Beneficiary:</label>
                                <input type="text" id="beneficiary" required>
                            </div>
                        </div>
                  
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pan">PAN Number:</label>
                                <input type="text" id="pan" required>
                            </div>
                        </div>
                  
                        <div class="form-row">
                            <div class="form-field">
                                <label>Vehicle Numbers:</label>
                                <div class="vehicle-numbers-container" id="vehicleNumbersContainer">
                                    <div class="vehicle-number-input">
                                        <input type="text" class="vehicleNumber" placeholder="Vehicle Number" required>
                                        <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>
                                    </div>
                                </div>
                                <button type="button" class="add-vehicle" onclick="addVehicleField()">Add Another Vehicle</button>
                            </div>
                        </div>
                  
                        <div class="form-row">
                            <button type="button" onclick="addNewVendor()">Save Vendor</button>
                            <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </section>
      
            <section class="saved-results-section" id="savedResultsSection">
                <div class="saved-results-header">
                    <div class="saved-results-title">Saved Results</div>
                    <div>
                        <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
                        <button type="button" class="btn-secondary" onclick="clearSavedResults()">Clear All</button>
                    </div>
                </div>
                <div class="saved-results-list" id="savedResultsList">
                    <!-- Saved results will be displayed here -->
                </div>
            </section>
        </div>
  
        <div class="dashboard-sidebar">
            <div class="dashboard-title">Monthly Dashboard</div>
      
            <div class="dashboard-section">
                <div class="dashboard-section-title">Overall Summary</div>
                <div class="dashboard-summary-box">
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Vehicles:</span>
                        <span class="dashboard-value" id="totalVehicles">0</span>
                    </div>
          
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Quantity:</span>
                        <span class="dashboard-value" id="totalQuantity">0.00</span>
                    </div>
                    <div class="dashboard-summary-item dashboard-highlight">
                        <span class="dashboard-label">Total Amount:</span>
                        <span class="dashboard-value" id="totalAmount">₹0.00</span>
                    </div>
                </div>
            </div>
      
            <div class="dashboard-section">
                <div class="dashboard-section-title">Product Breakdown</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="productBreakdown">
                        <!-- Product breakdown will be displayed here -->
                    </div>
                </div>
            </div>
      
            <button type="button" class="dashboard-refresh" onclick="updateDashboard()">Refresh Dashboard</button>
        </div>
    </div>
    <!-- Load SheetJS with defer -->
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        'use strict';
        // -------------------------------------------------
        // DATA
        // -------------------------------------------------
        let vehicleData = [
            { partyName: "YARA GOVIND RAO - BT -2", accountNo: "29611100003742", bankName: "DCB Bank, Anakapalli", beneficiary: "YARA GOVIND RAO", pan: "AYBPY0969R", vehicleNumbers: ["AP39UY3435"] },
            { partyName: "GADASALA SHIVA", accountNo: "1420155000065560", bankName: "KVB", beneficiary: "Gadasala Shiva", pan: "BTSPG7175G", vehicleNumbers: ["AP39WC2389", "AP39UQ2489"] },
            { partyName: "Sri Modamamba Transport", accountNo: "6086101003133", bankName: "CANARA BANK", beneficiary: "Ommi Madhu babu", pan: "ABEYO1294K", vehicleNumbers: ["AP39UZ3335"] },
            { partyName: "Sri Vijayalaxmi Transport", accountNo: "868457131", bankName: "Indian Bank,Anakapalle", beneficiary: "S K Santosh Kumar", pan: "CWUPS1379C", vehicleNumbers: ["AP39W4518"] },
            { partyName: "SRI MODHAMAMBA TRANSPORT", accountNo: "6546322059", bankName: "Indian Bank Anakapalle", beneficiary: "MONDEPU GOPI", pan: "GDAPM7595D", vehicleNumbers: ["AP39WJ5869", "AP39UJ5678"] },
            { partyName: "SRI VARDHAN TRANSPORT", accountNo: "6086101005682", bankName: "CB Anakapalle", beneficiary: "PRIYANKA NAGULAPALLI", pan: "CCOPN9093G", vehicleNumbers: ["AP39W3579"] },
            { partyName: "SHREE NOOKAMBICA LORRY TRANSPORT", accountNo: "30893220505", bankName: "SBI, Anakapalle", beneficiary: "P.N.K.A Ananda Rao", pan: "CHOPP3166M", vehicleNumbers: ["AP39UF3245", "AP05TH2345", "AP39UP9239"] },
            { partyName: "LAKSHMI SRINIVASA TRANSPORT", accountNo: "053501505619", bankName: "ICICI, Anakapalle", beneficiary: "Gali Venkata Nukaraju", pan: "BQDPG9659K", vehicleNumbers: ["AP39W0505", "AP39WC7499"] },
            { partyName: "POLNATI RAMU", accountNo: "039301000039226", bankName: "Indian Overseas Bank-Anakapalli", beneficiary: "POLNATI RAMU", pan: "AMEPP6405E", vehicleNumbers: ["AP39TV2536", "AP39WB2536", "AP39WD2536"] },
            { partyName: "POLNATI LAKSHMANA", accountNo: "20393866584", bankName: "SBI, Anakapalle", beneficiary: "POLNATI LAKSHMANA", pan: "EHGPP6721J", vehicleNumbers: ["AP39TV2537"] },
            { partyName: "GADASALA VENKATA RAO", accountNo: "41897007408", bankName: "SBI, Anakapalle", beneficiary: "GADASALA VENKATA RAO", pan: "BNLPG8819G", vehicleNumbers: ["AP39UJ2489", "AP39UZ2489"] },
            { partyName: "Sri Durga Devi Lorry Services", accountNo: "30758927213", bankName: "SBI, Anakapalle", beneficiary: "N.Narisinga Rao", pan: "APCPN4125N", vehicleNumbers: ["AP39VE2979"] },
            { partyName: "BINDHU SREE TRANSPORT AND CONSTRUCTIONS", accountNo: "053505500548", bankName: "ICICI, Anakapalle", beneficiary: "NAMMI SUNITHA", pan: "BMHPB1489C", vehicleNumbers: ["AP39VC5289", "AP39UW2589"] },
            { partyName: "Sri Venkata Durga Lorry service", accountNo: "50100398807876", bankName: "HDFC, Anakapalle", beneficiary: "Ullingala Nageswar Rao", pan: "CKQPN5200B", vehicleNumbers: ["AP39TN2579", "AP39UJ2669"] },
            { partyName: "SRI MODAMAMBA LORRY TRANSPORT", accountNo: "386602010025075", bankName: "UNION BANK", beneficiary: "Lanka Nageswara Rao", pan: "AYWPL8780A", vehicleNumbers: ["AP39UU5665"] },
            { partyName: "SRI SIVA DURGA LORRY SERVICE", accountNo: "44005352428", bankName: "SBI, ANAKAPALLI", beneficiary: "Kommuri Durga Prasad", pan: "CKBPK7332L", vehicleNumbers: ["AP39WD8349"] },
            { partyName: "SRI MANIKANTA BALAJI LORRY TRANSPORT", accountNo: "33982901231", bankName: "SBI, Anakapalle", beneficiary: "M SOMUNAIDU", pan: "CLXPM8882N", vehicleNumbers: ["AP39WD4199"] },
            { partyName: "K DURGA RAO", accountNo: "184010100508162", bankName: "AXIS BANK OF INDIA ANAKAPALLE", beneficiary: "K.DURGA RAO", pan: "BCBPR6347H", vehicleNumbers: ["AP31TN4302", "AP39VB8829"] },
            { partyName: "YELLANKI Atrivardhan", accountNo: "2548572384", bankName: "KOTAK MAHINDRA BANK", beneficiary: "Yelanki Atrivardhan", pan: "BFPPY8560Q", vehicleNumbers: ["AP39UD1589"] },
            { partyName: "SIRI BUILDTECH", accountNo: "10230601834", bankName: "IDFC FIRST BANK", beneficiary: "Kondala Rao", pan: "CCAPK6960M", vehicleNumbers: ["AP39WH3659"] },
            { partyName: "DURGALAMMATALLI LORRY SERVICE", accountNo: "32949321587", bankName: "SBI ANAKAPALLE", beneficiary: "DASARI GOVINDA", pan: "CMJPD4773Q", vehicleNumbers: ["AP39WE9299", "AP39UM4767"] },
            { partyName: "SREE MODHAMAMBHA TRANSPORT", accountNo: "386602010026387", bankName: "UNION BANK", beneficiary: "B HEMANTH KUMAR", pan: "CEGPB5646M", vehicleNumbers: ["AP39WH2769", "AP39WH1869"] },
            { partyName: "POLNATI ANNAPURNA", accountNo: "6086101003959", bankName: "CANARA BANK", beneficiary: "Polnati Annapuran", pan: "DWOPP2749J", vehicleNumbers: ["AP39WC9149", "AP39UP9239"] },
            { partyName: "Sri Kanaka Durga Lorry transprot", accountNo: "3512984417", bankName: "Kotak Mahindra Anakapalli", beneficiary: "Karanam Uma Maheswara Rao", pan: "IBOPK6921H", vehicleNumbers: ["AP39UJ1166", "AP39W2399"] },
            { partyName: "Sri Polnati Venkata Srinivas Rao", accountNo: "11040675260", bankName: "SBI, Anakapalle", beneficiary: "Polnati Venkata Srinivasrao", pan: "EMOPP4189M", vehicleNumbers: ["AP39UH2489"] },
            { partyName: "Amma Durgamma Lorry Service", accountNo: "386602010021851", bankName: "UNION BANK, THUMMAPALA", beneficiary: "Pilla Satyanarayana", pan: "DIHPP4262D", vehicleNumbers: ["AP39WD3257"] },
            { partyName: "Mantri Srinu-Sri Durga Devi Lorry Service", accountNo: "50100738065516", bankName: "HDFC, Thummapala", beneficiary: "Mantri Srinu", pan: "CZOPM8907M", vehicleNumbers: ["AP39UE5162"] },
            { partyName: "Sri Durga Bhavani Lorry Service-Marturi Naga Raju", accountNo: "20206043601", bankName: "SBI, Anakapalle", beneficiary: "Mantri Naga Raju", pan: "CXLPM6771J", vehicleNumbers: ["AP39WB1629"] },
            { partyName: "Kasireddi Mahesh", accountNo: "43648650839", bankName: "SBI, Anakapalle", beneficiary: "Kasireddi Mahesh", pan: "", vehicleNumbers: ["AP39UD3969", "AP39WC9639"] },
            { partyName: "Sri Srinivasa Lorry Service", accountNo: "20284756803", bankName: "SBI, Koduru", beneficiary: "Allam Satyanarayana", pan: "DDYPA3023F", vehicleNumbers: ["AP16TS2425"] },
            { partyName: "Sri Srinivasa Transport", accountNo: "053501506656", bankName: "ICICI, Anakapalle", beneficiary: "Karanam Venkata Nageswara Rao", pan: "BWKPK3123P", vehicleNumbers: [] },
            { partyName: "P.V.Srinivasa Rao- (Sri Balaji Transport )", accountNo: "30794877494", bankName: "SBI, Anakapalle", beneficiary: "Polnati Venkata Srinivasrao", pan: "ENNPP6015C", vehicleNumbers: ["AP39WC5225"] },
            { partyName: "Srinivasa Minerals Products", accountNo: "50200105596341", bankName: "HDFC, Anakapalli", beneficiary: "", pan: "", vehicleNumbers: ["AP39WH3659"] }
        ];
        let transportData = [];
        let savedResults = [];
        // -------------------------------------------------
        // INITIALISATION
        // -------------------------------------------------
        function initApp() {
            setupSearchFunctionality();
            setupDCSearchFunctionality();
            loadTransportData();
            loadSavedResults();
        }
        // -------------------------------------------------
        // LOAD TRANSPORT EXCEL - CORRECTED URL
        // -------------------------------------------------
        async function loadTransportData() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '<div class="loading">Loading transport data...</div>';
            try {
                // Dynamic file name based on previous month
                const now = new Date();
                const previousMonth = new Date(now.getTime());
                previousMonth.setMonth(previousMonth.getMonth() - 1);
                const monthAbbr = previousMonth.toLocaleString('en-US', { month: 'short' });
                const yearShort = previousMonth.getFullYear() % 100;
                const fileName = `Agg%20Sales%20Report-${monthAbbr}-${yearShort}.xlsx`;
                // CORRECTED URL - Using raw.githubusercontent.com format with %20 for spaces
                const githubUrl = `https://raw.githubusercontent.com/bimal-bp/E-TRANSPORT-BILLING/main/${fileName}`;
             
                console.log('Fetching data from:', githubUrl);
             
                const resp = await fetch(githubUrl);
             
                if (!resp.ok) {
                    // Try alternative URL pattern if first one fails
                    const altUrl = `https://github.com/bimal-bp/E-TRANSPORT-BILLING/raw/main/${fileName}`;
                    console.log('Trying alternative URL:', altUrl);
                 
                    const altResp = await fetch(altUrl);
                 
                    if (!altResp.ok) {
                        throw new Error(`Failed to fetch Excel file. Status: ${resp.status} - ${resp.statusText}`);
                    }
                 
                    const altArrayBuffer = await altResp.arrayBuffer();
                    const workbook = XLSX.read(altArrayBuffer, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false, dateNF: 'yyyy-mm-dd'});
                    processTransportData(json);
                } else {
                    const arrayBuffer = await resp.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                 
                    // Log sheet names for debugging
                    console.log('Available sheets:', workbook.SheetNames);
                 
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false, dateNF: 'yyyy-mm-dd'});
                 
                    // Log first few rows for debugging
                    console.log('First 3 rows of data:', json.slice(0, 3));
                 
                    processTransportData(json);
                }
             
                resultsContent.innerHTML = '<div class="loading" style="color: #4caf50;">✓ Transport data loaded successfully! Search for a vehicle above.</div>';
             
                // Clear message after 3 seconds
                setTimeout(() => {
                    if (resultsContent.innerHTML.includes('successfully')) {
                        resultsContent.innerHTML = '';
                    }
                }, 3000);
             
                updateDashboard();
             
            } catch (e) {
                console.error('Error loading transport data:', e);
                resultsContent.innerHTML = `
                    <div class="warning">
                        <strong>Error loading transport data:</strong> ${e.message}<br><br>
                        <strong>Troubleshooting steps:</strong>
                        <ol>
                            <li>Make sure the Excel file exists at: <a href="https://github.com/bimal-bp/E-TRANSPORT-BILLING/blob/main/Agg%20Sales%20Report-Dec-25.xlsx" target="_blank">GitHub Link</a></li>
                            <li>Ensure the repository is public</li>
                            <li>Check the file name is exactly: "Agg Sales Report-Dec-25.xlsx"</li>
                            <li>Try refreshing the page</li>
                        </ol>
                        <button onclick="retryLoadTransportData()" style="margin-top: 10px; padding: 8px 16px; background: #1e88e5; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry Loading Data</button>
                    </div>`;
            }
        }
        function retryLoadTransportData() {
            loadTransportData();
        }
        function processTransportData(json) {
            if (!json || json.length < 2) {
                console.warn('No data or insufficient rows in Excel file');
                transportData = [];
                return;
            }
         
            const headers = json[0].map(h => (h ?? '').toString().trim());
            console.log('Excel headers:', headers);
         
            transportData = json.slice(1)
                .filter(row => row && row.length > 0)
                .map(row => {
                    const obj = {};
                    headers.forEach((h, i) => {
                        if (h && row[i] !== undefined) {
                            obj[h] = h === 'Accounting Date' ? convertExcelDate(row[i]) : row[i];
                        }
                    });
                    return obj;
                })
                .filter(obj => Object.keys(obj).length > 0);
         
            console.log(`Processed ${transportData.length} transport records`);
         
            // Log sample data for debugging
            if (transportData.length > 0) {
                console.log('Sample transport record:', transportData[0]);
            }
        }
        // -------------------------------------------------
        // DASHBOARD
        // -------------------------------------------------
        function updateDashboard() {
            if (transportData.length === 0) {
                document.getElementById('totalVehicles').textContent = '0';
                document.getElementById('totalQuantity').textContent = '0.00';
                document.getElementById('totalAmount').textContent = '₹0.00';
             
                document.getElementById('productBreakdown').innerHTML = '<div class="no-results">No data available</div>';
                return;
            }
            const totalVehicles = new Set();
            let totalQuantity = 0, totalAmount = 0;
            const productBreakdown = {};
            transportData.forEach(record => {
                const v = (record['VEHICLE NO'] || record['Vehicle Number'] || '').toString().trim().toUpperCase();
                if (v) totalVehicles.add(v);
                const qty = parseFloat(record['NET WT'] || record['Quantity'] || 0) || 0;
                const amt = parseFloat(record['Transport Amount'] || record['Amount'] || 0) || 0;
                totalQuantity += qty;
                totalAmount += amt;
                // Try different possible column names for product/material
                const prod = record['Material'] || record['Product'] || record['ITEM'] || 'Unknown';
                if (!productBreakdown[prod]) productBreakdown[prod] = {qty:0, amt:0};
                productBreakdown[prod].qty += qty;
                productBreakdown[prod].amt += amt;
            });
            document.getElementById('totalVehicles').textContent = totalVehicles.size;
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
            const pb = document.getElementById('productBreakdown');
            pb.innerHTML = '';
         
            if (Object.keys(productBreakdown).length === 0) {
                pb.innerHTML = '<div class="no-results">No product data found</div>';
                return;
            }
         
            Object.entries(productBreakdown)
                .sort((a,b) => b[1].qty - a[1].qty)
                .forEach(([p,d]) => {
                    const el = document.createElement('div');
                    el.className='product-item';
                    el.innerHTML = `
                        <div class="product-name">${p}</div>
                        <div class="product-qty">${d.qty.toFixed(2)}</div>
                        <div class="product-amount">₹${d.amt.toFixed(2)}</div>`;
                    pb.appendChild(el);
                });
        }
        // -------------------------------------------------
        // SEARCH / SUGGESTIONS FOR VEHICLE
        // -------------------------------------------------
        function setupSearchFunctionality() {
            const input = document.getElementById('vehicleSearch');
            const cont = document.getElementById('suggestionsContainer');
            input.addEventListener('input', () => {
                const term = input.value.trim().toUpperCase();
                if (!term) {
                    cont.style.display='none';
                    return;
                }
                const matches = getMatchingVehicles(term);
                displaySuggestions(matches, term, cont, input);
            });
            document.addEventListener('click', e => {
                if (!input.contains(e.target) && !cont.contains(e.target)) {
                    cont.style.display='none';
                }
            });
            input.addEventListener('keydown', e => {
                const items = cont.querySelectorAll('.suggestion-item');
                const active = cont.querySelector('.suggestion-item.active');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (items.length) {
                        cont.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                        const nextIndex = active ? (Array.from(items).indexOf(active) + 1) % items.length : 0;
                        items[nextIndex].classList.add('active');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (active) {
                        const items = cont.querySelectorAll('.suggestion-item');
                        const currentIndex = Array.from(items).indexOf(active);
                        const prevIndex = (currentIndex - 1 + items.length) % items.length;
                     
                        cont.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                        items[prevIndex].classList.add('active');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (active) {
                        input.value = active.textContent;
                        cont.style.display='none';
                        searchVehicle();
                    } else {
                        searchVehicle();
                    }
                }
            });
        }
        // -------------------------------------------------
        // SEARCH / SUGGESTIONS FOR DC
        // -------------------------------------------------
        function setupDCSearchFunctionality() {
            const input = document.getElementById('dcSearch');
            const cont = document.getElementById('dcSuggestionsContainer');
            input.addEventListener('input', () => {
                const term = input.value.trim().toUpperCase();
                if (!term) {
                    cont.style.display='none';
                    return;
                }
                const matches = getMatchingDCs(term);
                displaySuggestions(matches, term, cont, input);
            });
            document.addEventListener('click', e => {
                if (!input.contains(e.target) && !cont.contains(e.target)) {
                    cont.style.display='none';
                }
            });
            input.addEventListener('keydown', e => {
                const items = cont.querySelectorAll('.suggestion-item');
                const active = cont.querySelector('.suggestion-item.active');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (items.length) {
                        cont.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                        const nextIndex = active ? (Array.from(items).indexOf(active) + 1) % items.length : 0;
                        items[nextIndex].classList.add('active');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (active) {
                        const items = cont.querySelectorAll('.suggestion-item');
                        const currentIndex = Array.from(items).indexOf(active);
                        const prevIndex = (currentIndex - 1 + items.length) % items.length;
                     
                        cont.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                        items[prevIndex].classList.add('active');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (active) {
                        input.value = active.textContent;
                        cont.style.display='none';
                        searchDC();
                    } else {
                        searchDC();
                    }
                }
            });
        }
        function getMatchingVehicles(term) {
            const set = new Set();
         
            // Search in vendor data
            vehicleData.forEach(v => {
                v.vehicleNumbers.forEach(n => {
                    if (n && n.toUpperCase().includes(term)) set.add(n);
                });
            });
         
            // Search in transport data
            transportData.forEach(r => {
                const v = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                if (v && v.includes(term)) set.add(v);
            });
         
            return Array.from(set)
                .sort((a,b) => {
                    // Sort by exact match first, then by position of match
                    const aExact = a === term;
                    const bExact = b === term;
                    if (aExact && !bExact) return -1;
                    if (!aExact && bExact) return 1;
                    return a.indexOf(term) - b.indexOf(term);
                });
        }
        function getMatchingDCs(term) {
            const set = new Set();
         
            // Search in transport data for DC NO
            transportData.forEach(r => {
                const dc = (r['DC NO'] || '').toString().trim().toUpperCase();
                if (dc && dc.includes(term)) set.add(dc);
            });
         
            return Array.from(set)
                .sort((a,b) => {
                    const aExact = a === term;
                    const bExact = b === term;
                    if (aExact && !bExact) return -1;
                    if (!aExact && bExact) return 1;
                    return a.indexOf(term) - b.indexOf(term);
                });
        }
        function displaySuggestions(matches, term, cont, input) {
            cont.innerHTML='';
         
            if (!matches.length) {
                cont.style.display='none';
                return;
            }
         
            matches.forEach(m => {
                const el = document.createElement('div');
                el.className='suggestion-item';
                el.innerHTML = m.replace(new RegExp(term,'gi'), '<span class="highlight">$&</span>');
                el.onclick = () => {
                    input.value = m;
                    cont.style.display='none';
                    if (input.id === 'vehicleSearch') {
                        searchVehicle();
                    } else {
                        searchDC();
                    }
                };
                el.onmouseover = () => {
                    cont.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                };
                cont.appendChild(el);
            });
            cont.style.display='block';
        }
        // -------------------------------------------------
        // MAIN SEARCH FOR VEHICLE
        // -------------------------------------------------
        function searchVehicle() {
            const term = document.getElementById('vehicleSearch').value.trim().toUpperCase();
            if (!term) {
                alert('Please enter a vehicle number');
                return;
            }
            const vendorMatches = vehicleData.filter(v =>
                v.vehicleNumbers.some(n => n.toUpperCase() === term)
            );
            // Find transport records - check multiple possible column names
            const transportRecords = transportData.filter(r => {
                const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                return vehicleNo === term;
            });
            // Store full context BEFORE display
            window.currentSearch = {
                type: 'vehicle',
                searchValue: term,
                vendorDetails: vendorMatches,
                transportRecords: transportRecords,
                allVendorVehicles: [],
                vendorTotals: {totalVehicles:0, totalRecords:0, totalQuantity:0, totalAmount:0},
                manualAmount: null
            };
            // Get all vehicles for matched vendors
            const allVeh = new Set();
            vendorMatches.forEach(v => v.vehicleNumbers.forEach(n => allVeh.add(n)));
            window.currentSearch.allVendorVehicles = Array.from(allVeh);
            displayResults(vendorMatches, term, transportRecords);
        }
        // -------------------------------------------------
        // MAIN SEARCH FOR DC - MODIFIED TO HANDLE MULTIPLE DC NUMBERS
        // -------------------------------------------------
        function searchDC() {
            const inputValue = document.getElementById('dcSearch').value.trim().toUpperCase();
            if (!inputValue) {
                alert('Please enter at least one Delivery Challan No');
                return;
            }
            // Split by space or comma for multiple DCs
            const terms = inputValue.split(/\s*[\s,]\s*/).filter(t => t);
            let allTransportRecords = [];
            let allVehicles = new Set();
            terms.forEach(term => {
                const records = transportData.filter(r => {
                    const dcNo = (r['DC NO'] || r['Delivery Challan No'] || '').toString().trim().toUpperCase();
                    return dcNo === term;
                });
                allTransportRecords.push(...records);
                records.forEach(r => {
                    const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                    if (vehicleNo) allVehicles.add(vehicleNo);
                });
            });
            if (!allTransportRecords.length) {
                displayNoResults();
                return;
            }
            // Group records by vehicle
            const recordsByVehicle = {};
            allTransportRecords.forEach(r => {
                const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                if (!recordsByVehicle[vehicleNo]) recordsByVehicle[vehicleNo] = [];
                recordsByVehicle[vehicleNo].push(r);
            });
            // Find vendors for all vehicles
            const vendorMatches = vehicleData.filter(v =>
                v.vehicleNumbers.some(n => allVehicles.has(n.toUpperCase()))
            );
            // Store full context
            window.currentSearch = {
                type: 'dc',
                searchValue: terms.join(', '),
                vehicleNumber: Array.from(allVehicles).join(', '),
                vendorDetails: vendorMatches,
                transportRecords: allTransportRecords,
                allVendorVehicles: [],
                vendorTotals: {totalVehicles:0, totalRecords:0, totalQuantity:0, totalAmount:0},
                manualAmount: null
            };
            // Get all vehicles for matched vendors
            const allVeh = new Set();
            vendorMatches.forEach(v => v.vehicleNumbers.forEach(n => allVeh.add(n)));
            window.currentSearch.allVendorVehicles = Array.from(allVeh);
            // Display results, but since multiple, display grouped by vehicle
            displayResults(vendorMatches, terms.join(', '), allTransportRecords);
            // Display transport for each vehicle
            Object.entries(recordsByVehicle).forEach(([veh, recs]) => {
                displayTransportDetails(veh, recs);
            });
            // If no vendor, show option to add
            if (!vendorMatches.length) {
                const cont = document.getElementById('resultsContent');
                const btn = document.createElement('button');
                btn.className = 'btn-secondary';
                btn.textContent = 'Add Vendor for these Vehicles';
                btn.onclick = () => addVendorForVehicle(Array.from(allVehicles).join(', '));
                cont.appendChild(btn);
            }
        }
        function displayNoResults() {
            const sec = document.getElementById('resultsSection');
            const cont = document.getElementById('resultsContent');
            cont.innerHTML = '<div class="no-results">No data found for this search.</div>';
            sec.style.display = 'block';
            sec.scrollIntoView({behavior: 'smooth'});
        }
        function displayResults(vendorMatches, searchValue, transportRecords) {
            const sec = document.getElementById('resultsSection');
            const cont = document.getElementById('resultsContent');
            cont.innerHTML='';
            if (vendorMatches.length === 0) {
                if (transportRecords.length) {
                    cont.innerHTML = '<div class="warning"><strong>Note:</strong> Vendor details not found in database, but transport records exist.</div>';
                    // Display transport details grouped
                    const recordsByVeh = {};
                    transportRecords.forEach(r => {
                        const veh = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                        if (!recordsByVeh[veh]) recordsByVeh[veh] = [];
                        recordsByVeh[veh].push(r);
                    });
                    Object.entries(recordsByVeh).forEach(([veh, recs]) => {
                        displayTransportDetails(veh, recs);
                    });
                } else {
                    cont.innerHTML = '<div class="no-results">No vendor or transport data found for this vehicle number.</div>';
                }
                sec.style.display='block';
                sec.scrollIntoView({behavior:'smooth'});
                return;
            }
            // Group vendors by party name and PAN (in case of duplicates)
            const groups = {};
            vendorMatches.forEach(v => {
                const key = `${v.partyName}|${v.pan}`;
                if (!groups[key]) {
                    groups[key] = {
                        vendor: v,
                        vehicles: []
                    };
                }
                v.vehicleNumbers.forEach(n => {
                    if (!groups[key].vehicles.includes(n)) {
                        groups[key].vehicles.push(n);
                    }
                });
            });
            // Display each vendor group (transporter-wise)
            Object.values(groups).forEach((g, idx) => {
                const vg = document.createElement('div');
                vg.className='vendor-group';
             
                const hdr = document.createElement('div');
                hdr.className='vendor-header';
                hdr.innerHTML = `
                    <div>
                        <div class="result-title">${g.vendor.partyName}</div>
                        <div><strong>PAN:</strong> ${g.vendor.pan || 'Not provided'}</div>
                    </div>
                    <div>${g.vehicles.length} Vehicle${g.vehicles.length !== 1 ? 's' : ''}</div>`;
                hdr.onclick = () => {
                    const vehDiv = document.getElementById(`veh${idx}`);
                    vehDiv.classList.toggle('expanded');
                };
                vg.appendChild(hdr);
                const vehDiv = document.createElement('div');
                vehDiv.id = `veh${idx}`;
                vehDiv.className='vendor-vehicles';
             
                g.vehicles.forEach(vn => {
                    const opt = document.createElement('div');
                    opt.className='vehicle-option';
                    if (vn === searchValue) opt.classList.add('selected');
                    opt.textContent = vn;
                    opt.onclick = () => {
                        document.getElementById('vehicleSearch').value = vn;
                        searchVehicle();
                    };
                    vehDiv.appendChild(opt);
                });
                vg.appendChild(vehDiv);
                cont.appendChild(vg);
                // Display vendor bank details
                const det = document.createElement('div');
                det.className='result-item';
                det.innerHTML = `
                    <div><strong>Bank Account:</strong> ${g.vendor.accountNo}</div>
                    <div><strong>Bank & Branch:</strong> ${g.vendor.bankName}</div>
                    <div><strong>Beneficiary:</strong> ${g.vendor.beneficiary}</div>`;
                cont.appendChild(det);
                // Display transport details for this vendor
                displayVendorTransportDetails(g.vendor, g.vehicles);
            });
            sec.style.display='block';
            sec.scrollIntoView({behavior:'smooth'});
        }
        function displayVendorTransportDetails(vendor, vehicleNumbers) {
            const allRecs = [];
            let totQty = 0, totAmt = 0, totRec = 0;
            vehicleNumbers.forEach(vn => {
                const recs = transportData.filter(r => {
                    const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                    return vehicleNo === vn;
                });
                recs.forEach(r => {
                    totQty += parseFloat(r['NET WT'] || r['Quantity'] || 0) || 0;
                    totAmt += parseFloat(r['Transport Amount'] || r['Amount'] || 0) || 0;
                    totRec++;
                });
                allRecs.push(...recs);
            });
            window.currentSearch.vendorTotals = {
                totalVehicles: vehicleNumbers.length,
                totalRecords: totRec,
                totalQuantity: totQty,
                totalAmount: totAmt
            };
            // Create vendor total summary
            const sum = document.createElement('div');
            sum.className='vendor-total-summary';
            sum.innerHTML = `
                <div class="vendor-total-title">Vendor Total Summary</div>
                <div class="vendor-total-details">
                    <div class="vendor-total-item">
                        <div class="vendor-total-label">Vehicles</div>
                        <div class="vendor-total-value">${vehicleNumbers.length}</div>
                    </div>
                    <div class="vendor-total-item">
                        <div class="vendor-total-label">Records</div>
                        <div class="vendor-total-value">${totRec}</div>
                    </div>
                    <div class="vendor-total-item">
                        <div class="vendor-total-label">Quantity</div>
                        <div class="vendor-total-value">${totQty.toFixed(2)}</div>
                    </div>
                    <div class="vendor-total-item">
                        <div class="vendor-total-label">Amount</div>
                        <div class="vendor-total-value">₹${totAmt.toFixed(2)}</div>
                    </div>
                </div>`;
            document.getElementById('resultsContent').appendChild(sum);
            // Display transport details for each vehicle
            vehicleNumbers.forEach(vn => {
                const recs = allRecs.filter(r => {
                    const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                    return vehicleNo === vn;
                });
                if (recs.length) {
                    displayTransportDetails(vn, recs);
                }
            });
        }
        function displayTransportDetails(vehicleNumber, records) {
            if (!records.length) return;
         
            const div = document.createElement('div');
            div.className='transport-details';
            const safe = vehicleNumber.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g, '');
         
            div.innerHTML = `
                <div class="result-title">Transport Details for Vehicle: ${vehicleNumber}</div>
                <table class="transport-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Delivery Challan No</th>
                            <th>Weighment Slip No</th>
                            <th>Vehicle</th>
                            <th>Material</th>
                            <th>Net Wt</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_${safe}"></tbody>
                </table>
                <div class="summary-box" id="summary_${safe}">
                    <div class="summary-item">
                        <div class="summary-label">Records</div>
                        <div class="summary-value" id="recs_${safe}">0</div>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item">
                        <div class="summary-label">Quantity</div>
                        <div class="summary-value" id="qty_${safe}">0.00</div>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item">
                        <div class="summary-label">Amount</div>
                        <div class="summary-value" id="amt_${safe}">0.00</div>
                    </div>
                </div>
                <div class="amount-edit">
                    <label for="manual_${safe}">Manual Amount Override:</label>
                    <input type="number" id="manual_${safe}" class="amount-input" placeholder="Enter manual amount">
                    <button type="button" class="btn-update" onclick="updateTotalAmount('${vehicleNumber}')">Update Amount</button>
                </div>`;
         
            document.getElementById('resultsContent').appendChild(div);
            const tbody = document.getElementById(`tbody_${safe}`);
            let qty = 0, amt = 0;
         
            records.forEach(r => {
                const tr = document.createElement('tr');
                tr.onclick = () => toggleVerify(tr);
                tr.innerHTML = `
                    <td>${formatDateForDisplay(r['Accounting Date'] || r['Date'])}</td>
                    <td>${r['NAME OF THE CUSTOMER'] || r['Customer Name'] || ''}</td>
                    <td>${r['DC NO'] || r['Delivery Challan No'] || ''}</td>
                    <td>${r['WEIGHMENT SLIP NO'] || r['Weighment Slip No'] || r['Weight Slip NO'] || ''}</td>
                    <td>${r['VEHICLE NO'] || r['Vehicle Number'] || ''}</td>
                    <td>${r['Material'] || r['Product'] || r['ITEM'] || ''}</td>
                    <td>${r['NET WT'] || r['Quantity'] || '0.00'}</td>
                    <td>${r['Transport Rate'] || r['Rate'] || '0.00'}</td>
                    <td>${r['Transport Amount'] || r['Amount'] || '0.00'}</td>`;
                tbody.appendChild(tr);
             
                qty += parseFloat(r['NET WT'] || r['Quantity'] || 0) || 0;
                amt += parseFloat(r['Transport Amount'] || r['Amount'] || 0) || 0;
            });
            document.getElementById(`recs_${safe}`).textContent = records.length;
            document.getElementById(`qty_${safe}`).textContent = qty.toFixed(2);
            document.getElementById(`amt_${safe}`).textContent = amt.toFixed(2);
            document.getElementById(`manual_${safe}`).value = amt.toFixed(2);
        }
        function toggleVerify(row) {
            row.classList.toggle('verified');
        }
        function updateTotalAmount(vehicleNumber) {
            const safe = vehicleNumber.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g, '');
            const val = parseFloat(document.getElementById(`manual_${safe}`).value);
         
            if (isNaN(val) || val < 0) {
                alert('Please enter a valid positive amount');
                return;
            }
         
            document.getElementById(`amt_${safe}`).textContent = val.toFixed(2);
            window.currentSearch.manualAmount = val;
         
            // Update vendor totals if this is the searched vehicle
            if (vehicleNumber === window.currentSearch.vehicleNumber || window.currentSearch.type === 'dc') {
                window.currentSearch.vendorTotals.totalAmount = val;
            }
        }
        // -------------------------------------------------
        // SAVE TO LIST
        // -------------------------------------------------
        function saveCurrentResult() {
            if (!window.currentSearch) {
                alert('No search results to save. Please search for a vehicle first.');
                return;
            }
            const vendor = window.currentSearch.vendorDetails[0] || null;
            const allVeh = window.currentSearch.allVendorVehicles;
            const key = vendor ? `${vendor.partyName}|${vendor.pan}` : window.currentSearch.searchValue;
            const allRecs = [];
            let totQty = 0, totAmt = 0, totRec = 0;
         
            allVeh.forEach(vn => {
                const recs = transportData.filter(r => {
                    const vehicleNo = (r['VEHICLE NO'] || r['Vehicle Number'] || '').toString().trim().toUpperCase();
                    return vehicleNo === vn;
                });
                recs.forEach(r => {
                    totQty += parseFloat(r['NET WT'] || r['Quantity'] || 0) || 0;
                    totAmt += parseFloat(r['Transport Amount'] || r['Amount'] || 0) || 0;
                    totRec++;
                });
                allRecs.push(...recs);
            });
            const finalAmt = window.currentSearch.manualAmount !== null ?
                window.currentSearch.manualAmount : totAmt;
            const obj = {
                type: window.currentSearch.type,
                searchValue: window.currentSearch.searchValue,
                vehicleNumber: window.currentSearch.vehicleNumber || window.currentSearch.searchValue,
                vendorDetails: vendor ? [vendor] : [],
                allVendorVehicles: allVeh,
                allVendorTransportRecords: allRecs,
                vendorTotals: {
                    totalVehicles: allVeh.length,
                    totalRecords: totRec,
                    totalQuantity: totQty,
                    totalAmount: finalAmt
                },
                timestamp: new Date().toISOString(),
                searchTime: new Date().toLocaleString()
            };
            // Check if already exists
            const idx = savedResults.findIndex(r => {
                const existingKey = r.vendorDetails[0] ?
                    `${r.vendorDetails[0].partyName}|${r.vendorDetails[0].pan}` :
                    r.searchValue;
                return existingKey === key;
            });
            if (idx > -1) {
                if (confirm('A result for this vendor already exists. Replace it?')) {
                    savedResults[idx] = obj;
                } else {
                    return;
                }
            } else {
                savedResults.push(obj);
            }
            saveSavedResults();
            displaySavedResults();
            alert('Result saved successfully!');
        }
        // -------------------------------------------------
        // SAVED RESULTS
        // -------------------------------------------------
        function loadSavedResults() {
            try {
                const raw = localStorage.getItem('transportSavedResults');
                if (raw) {
                    savedResults = JSON.parse(raw);
                    displaySavedResults();
                }
            } catch (e) {
                console.error('Error loading saved results:', e);
                savedResults = [];
            }
        }
     
        function saveSavedResults() {
            localStorage.setItem('transportSavedResults', JSON.stringify(savedResults));
        }
        function displaySavedResults() {
            const list = document.getElementById('savedResultsList');
            if (!savedResults.length) {
                list.innerHTML='<div class="no-results">No saved results yet. Search for a vehicle and click "Save to List".</div>';
                return;
            }
         
            list.innerHTML='';
            savedResults.forEach((r,i) => {
                const v = r.vendorDetails[0] || null;
                const t = r.vendorTotals;
                const el = document.createElement('div');
                el.className='saved-result-item';
                el.innerHTML = `
                    <div class="saved-result-info">
                        <div class="result-title">${v ? v.partyName : 'No Vendor'}</div>
                        <div><strong>PAN:</strong> ${v ? v.pan : 'N/A'}</div>
                        <div><strong>Vehicles:</strong> ${t.totalVehicles}</div>
                        <div><strong>Records:</strong> ${t.totalRecords}</div>
                        <div><strong>Total Quantity:</strong> ${t.totalQuantity.toFixed(2)}</div>
                        <div><strong>Total Amount:</strong> ₹${t.totalAmount.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Saved: ${r.searchTime || 'Recently'}
                        </div>
                    </div>
                    <div class="saved-result-actions">
                        <button type="button" class="btn-view" onclick="viewSavedResult(${i})">View</button>
                        <button type="button" class="btn-remove" onclick="removeSavedResult(${i})">Remove</button>
                    </div>`;
                list.appendChild(el);
            });
        }
        function viewSavedResult(idx) {
            const r = savedResults[idx];
            if (!r) return;
         
            if (r.type === 'vehicle') {
                document.getElementById('vehicleSearch').value = r.searchValue;
                searchVehicle();
            } else {
                document.getElementById('dcSearch').value = r.searchValue;
                searchDC();
            }
        }
        function removeSavedResult(idx) {
            if (confirm('Are you sure you want to remove this saved result?')) {
                savedResults.splice(idx,1);
                saveSavedResults();
                displaySavedResults();
            }
        }
        function clearSavedResults() {
            if (!savedResults.length) {
                alert('No saved results to clear.');
                return;
            }
         
            if (confirm('Are you sure you want to clear ALL saved results? This action cannot be undone.')) {
                savedResults = [];
                saveSavedResults();
                displaySavedResults();
            }
        }
        // -------------------------------------------------
        // DOWNLOAD EXCEL
        // -------------------------------------------------
        function downloadSavedResults() {
            if (!savedResults.length) {
                alert('No saved results to export. Please save some results first.');
                return;
            }
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                alert('Excel library not loaded. Please refresh the page and try again.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                // Summary sheet
                const summaryData = [
                    ['Vendor Name', 'PAN', 'Account No', 'Bank Name', 'Beneficiary', 'Total Vehicles', 'Total Records', 'Total Quantity', 'Total Amount', 'Saved Time']
                ];
             
                savedResults.forEach(r => {
                    const v = r.vendorDetails[0] || {};
                    const t = r.vendorTotals;
                    summaryData.push([
                        v.partyName || 'N/A',
                        v.pan || 'N/A',
                        v.accountNo || 'N/A',
                        v.bankName || 'N/A',
                        v.beneficiary || 'N/A',
                        t.totalVehicles,
                        t.totalRecords,
                        t.totalQuantity,
                        t.totalAmount,
                        r.searchTime || new Date().toLocaleString()
                    ]);
                });
             
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
                // Detailed sheets for each vendor
                savedResults.forEach((r, i) => {
                    const v = r.vendorDetails[0] || {};
                    const sheetName = (v.partyName || `Vendor_${i+1}`)
                        .replace(/[^\w\s]/g, '')
                        .substring(0, 31);
                 
                    const detailData = [
                        ['Date', 'Customer', 'Delivery Challan No', 'Weighment Slip No', 'Vehicle', 'Material', 'Net Weight', 'Rate', 'Amount']
                    ];
                 
                    r.allVendorTransportRecords.forEach(rec => {
                        detailData.push([
                            formatDateForDisplay(rec['Accounting Date'] || rec['Date']),
                            rec['NAME OF THE CUSTOMER'] || rec['Customer Name'] || '',
                            rec['DC NO'] || rec['Delivery Challan No'] || '',
                            rec['WEIGHMENT SLIP NO'] || rec['Weighment Slip No'] || rec['Weight Slip NO'] || '',
                            rec['VEHICLE NO'] || rec['Vehicle Number'] || '',
                            rec['Material'] || rec['Product'] || rec['ITEM'] || '',
                            rec['NET WT'] || rec['Quantity'] || '',
                            rec['Transport Rate'] || rec['Rate'] || '',
                            rec['Transport Amount'] || rec['Amount'] || ''
                        ]);
                    });
                 
                    const detailSheet = XLSX.utils.aoa_to_sheet(detailData);
                    XLSX.utils.book_append_sheet(wb, detailSheet, sheetName);
                });
                // Generate filename with current date
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const filename = `Transport_Billing_Report_${dateStr}.xlsx`;
             
                XLSX.writeFile(wb, filename);
             
            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Error generating Excel file: ' + error.message);
            }
        }
        // -------------------------------------------------
        // MISC FUNCTIONS
        // -------------------------------------------------
        function printResults() {
            window.print();
        }
        function toggleAddVendorForm() {
            const sec = document.getElementById('addVendorSection');
            const res = document.getElementById('resultsSection');
         
            if (sec.style.display === 'block') {
                sec.style.display = 'none';
                document.getElementById('vendorForm').reset();
                const cont = document.getElementById('vehicleNumbersContainer');
                while (cont.children.length > 1) {
                    cont.removeChild(cont.lastChild);
                }
            } else {
                sec.style.display = 'block';
                res.style.display = 'none';
                sec.scrollIntoView({behavior:'smooth'});
            }
        }
        function addVehicleField() {
            const cont = document.getElementById('vehicleNumbersContainer');
            const div = document.createElement('div');
            div.className='vehicle-number-input';
            div.innerHTML = `
                <input type="text" class="vehicleNumber" placeholder="Vehicle Number" required>
                <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>`;
            cont.appendChild(div);
        }
        function removeVehicleField(btn) {
            const cont = document.getElementById('vehicleNumbersContainer');
            if (cont.children.length > 1) {
                cont.removeChild(btn.parentNode);
            }
        }
        function addNewVendor() {
            const party = document.getElementById('partyName').value.trim();
            const acc = document.getElementById('accountNo').value.trim();
            const bank = document.getElementById('bankName').value.trim();
            const ben = document.getElementById('beneficiary').value.trim();
            const pan = document.getElementById('pan').value.trim().toUpperCase();
         
            const inputs = document.querySelectorAll('.vehicleNumber');
            const veh = Array.from(inputs)
                .map(i => i.value.trim().toUpperCase())
                .filter(v => v);
         
            if (!party || !acc || !bank || !ben || !pan || veh.length === 0) {
                alert('Please fill all required fields and add at least one vehicle number.');
                return;
            }
         
            // Check if PAN is valid format
            if (!/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan)) {
                alert('Please enter a valid PAN number (format: ABCDE1234F)');
                return;
            }
         
            // Check if vendor already exists
            const existingVendor = vehicleData.find(v =>
                v.partyName === party || v.pan === pan
            );
         
            if (existingVendor) {
                if (confirm('A vendor with this name or PAN already exists. Add anyway?')) {
                    vehicleData.push({
                        partyName: party,
                        accountNo: acc,
                        bankName: bank,
                        beneficiary: ben,
                        pan: pan,
                        vehicleNumbers: veh
                    });
                } else {
                    return;
                }
            } else {
                vehicleData.push({
                    partyName: party,
                    accountNo: acc,
                    bankName: bank,
                    beneficiary: ben,
                    pan: pan,
                    vehicleNumbers: veh
                });
            }
         
            alert('Vendor added successfully!');
            document.getElementById('vendorForm').reset();
            toggleAddVendorForm();
        }
        function addVendorForVehicle(veh) {
            toggleAddVendorForm();
            document.querySelector('.vehicleNumber').value = veh;
        }
        // -------------------------------------------------
        // HELPER FUNCTIONS
        // -------------------------------------------------
        function convertExcelDate(v) {
            if (!v) return '';
         
            if (typeof v === 'string' && v.includes('-')) {
                return v;
            }
         
            if (typeof v === 'number') {
                // Excel date serial number (days since 1900-01-00)
                const excelEpoch = new Date(1900, 0, 1);
                const days = v - 2; // Excel incorrectly treats 1900 as leap year
                const date = new Date(excelEpoch.getTime() + days * 86400000);
                return date.toISOString().split('T')[0];
            }
         
            return v;
        }
        function formatDateForDisplay(v) {
            if (!v) return '';
         
            if (typeof v === 'string' && v.includes('-')) {
                const d = new Date(v);
                return !isNaN(d.getTime()) ? d.toLocaleDateString('en-IN') : v;
            }
         
            if (v instanceof Date) {
                return v.toLocaleDateString('en-IN');
            }
         
            return v;
        }
        // -------------------------------------------------
        // INITIALIZE APP
        // -------------------------------------------------
        window.onload = initApp;
    </script>
</body>
</html>
